{% extends 'base.html' %}
{% block title %}Manual Video Tagging{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto space-y-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-base-content">Manual Video Tagging</h1>
            <p class="text-base-content/70 mt-1">Review videos without detected faces and add people tags.</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="{{ url_for('manual_video_next') }}" class="btn btn-primary" {% if (counts['pending'] or 0) + (counts['in_progress'] or 0) == 0 %}disabled{% endif %}>
                Start Next Video
            </a>
            <a href="{{ url_for('manual_video_dashboard') }}" class="btn btn-outline">Refresh</a>
        </div>
    </div>

    <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
        <!-- Pending - warning/yellow accent -->
        <div class="card bg-base-100 shadow-sm border-l-4 border-warning">
            <div class="card-body p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-warning/10">
                        <svg class="w-5 h-5 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-base-content/70">Pending</p>
                        <p class="text-2xl font-bold">{{ counts['pending'] or 0 }}</p>
                    </div>
                </div>
                <p class="text-xs text-base-content/60 mt-1">Waiting for review</p>
            </div>
        </div>
        <!-- In Progress - info/blue accent -->
        <div class="card bg-base-100 shadow-sm border-l-4 border-info">
            <div class="card-body p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-info/10">
                        <svg class="w-5 h-5 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-base-content/70">In Progress</p>
                        <p class="text-2xl font-bold">{{ counts['in_progress'] or 0 }}</p>
                    </div>
                </div>
                <p class="text-xs text-base-content/60 mt-1">Currently open</p>
            </div>
        </div>
        <!-- Completed - success/green accent -->
        <div class="card bg-base-100 shadow-sm border-l-4 border-success">
            <div class="card-body p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-success/10">
                        <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-base-content/70">Completed</p>
                        <p class="text-2xl font-bold">{{ counts['done'] or 0 }}</p>
                    </div>
                </div>
                <p class="text-xs text-base-content/60 mt-1">Tagged with people</p>
            </div>
        </div>
        <!-- No People - neutral accent -->
        <div class="card bg-base-100 shadow-sm border-l-4 border-base-content/20">
            <div class="card-body p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-base-content/5">
                        <svg class="w-5 h-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-base-content/70">No People</p>
                        <p class="text-2xl font-bold">{{ counts['no_people'] or 0 }}</p>
                    </div>
                </div>
                <p class="text-xs text-base-content/60 mt-1">Reviewed and confirmed empty</p>
            </div>
        </div>
    </div>

    <div class="card bg-base-100 shadow-lg">
        <div class="card-body space-y-4">
            <form method="get" action="{{ url_for('manual_video_dashboard') }}" class="space-y-2">
                <label class="label">
                    <span class="label-text font-semibold flex items-center gap-2">
                        <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Search existing people
                    </span>
                </label>
                <div class="join w-full">
                    <input
                        type="text"
                        name="person"
                        list="manual-known-people"
                        value="{{ focus_person }}"
                        class="input input-bordered join-item w-full"
                        placeholder="Type a name to jump to their videos"
                    >
                    <button type="submit" class="btn btn-primary join-item">Search</button>
                    {% if focus_person %}
                    <a href="{{ url_for('manual_video_dashboard') }}" class="btn btn-ghost join-item" title="Clear search">Reset</a>
                    {% endif %}
                </div>
                <datalist id="manual-known-people">
                    {% for name in known_people %}
                    <option value="{{ name }}"></option>
                    {% endfor %}
                </datalist>
                <p class="text-xs text-base-content/60">Use this search to find videos that already feature someone or still need that tag applied.</p>
            </form>

            {% macro render_video_table(video_list, focus_person) %}
            {% if video_list %}
            <div class="overflow-x-auto -mx-2 sm:mx-0">
                <table class="table table-zebra text-sm">
                    <thead>
                        <tr>
                            <th class="text-xs sm:text-sm">Video</th>
                            <th class="text-xs sm:text-sm">Status</th>
                            <th class="text-left text-xs sm:text-sm hidden sm:table-cell">People Tags</th>
                            <th class="text-right text-xs sm:text-sm hidden md:table-cell">Faces</th>
                            <th class="text-right text-xs sm:text-sm">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set status_badges = {
                            'pending': 'badge badge-warning',
                            'in_progress': 'badge badge-info',
                            'done': 'badge badge-success',
                            'no_people': 'badge'
                        } %}
                        {% for video in video_list %}
                        <tr class="{% if video.matches_focus %}bg-primary/10{% endif %}">
                            {% if focus_person %}
                                {% set detail_url = url_for('manual_video_detail', file_hash=video.file_hash, focus_person=focus_person) %}
                            {% else %}
                                {% set detail_url = url_for('manual_video_detail', file_hash=video.file_hash) %}
                            {% endif %}
                            <td class="whitespace-normal max-w-[150px] sm:max-w-none">
                                <div class="flex flex-col">
                                    <span class="font-medium text-xs sm:text-sm truncate sm:whitespace-normal">{{ video.name or 'Unknown name' }}</span>
                                    <span class="text-xs text-base-content/60 hidden sm:inline">{{ video.file_hash }}</span>
                                    {% if video.missing %}
                                    <span class="text-xs text-error">Missing</span>
                                    {% endif %}
                                    <!-- Show tags on mobile inline -->
                                    <div class="flex flex-wrap gap-1 mt-1 sm:hidden">
                                        {% if video.tags %}
                                            {% for tag in video.tags[:2] %}
                                            <span class="badge badge-outline badge-xs">{{ tag }}</span>
                                            {% endfor %}
                                            {% if video.tags|length > 2 %}
                                            <span class="badge badge-ghost badge-xs">+{{ video.tags|length - 2 }}</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="{{ status_badges.get(video.status, 'badge') }} badge-sm sm:badge-md capitalize text-xs">{{ video.status.replace('_', ' ') }}</span>
                            </td>
                            <td class="hidden sm:table-cell">
                                <div class="flex flex-wrap gap-2">
                                    {% if video.tags %}
                                        {% for tag in video.tags %}
                                        <span class="badge badge-outline badge-sm">{{ tag }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-xs text-base-content/50">No tags yet</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-right hidden md:table-cell">{{ video.face_count or 0 }}</td>
                            <td class="text-right">
                                <div class="flex justify-end flex-wrap gap-1 sm:gap-2">
                                    <a href="{{ detail_url }}" class="btn btn-xs sm:btn-sm btn-outline">Open</a>
                                    {% if focus_person %}
                                        {% if video.matches_focus %}
                                            <span class="badge badge-primary badge-xs sm:badge-sm">Tagged</span>
                                        {% elif video.needs_focus %}
                                            <a href="{{ url_for('manual_video_detail', file_hash=video.file_hash, focus_person=focus_person) }}" class="btn btn-xs sm:btn-sm btn-primary"><span class="hidden sm:inline">Tag </span>{{ focus_person }}</a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            {% endmacro %}

            {% if focus_person %}
                {% if matching_videos %}
                <div class="space-y-2">
                    <h2 class="text-lg font-semibold">Videos already tagged with {{ focus_person }}</h2>
                    {{ render_video_table(matching_videos, focus_person) }}
                </div>
                {% endif %}

                {% if suggested_videos %}
                <div class="space-y-2">
                    <h2 class="text-lg font-semibold">Suggested videos to tag with {{ focus_person }}</h2>
                    <p class="text-sm text-base-content/60">Jump in and add {{ focus_person }} to these pending reviews.</p>
                    {{ render_video_table(suggested_videos, focus_person) }}
                </div>
                {% endif %}

                {% if not matching_videos and not suggested_videos %}
                <div class="alert bg-base-200">
                    <span>No manual videos currently reference {{ focus_person }}. Once you add them, they will appear here.</span>
                </div>
                {% endif %}

                {% if other_videos %}
                <details class="collapse collapse-arrow bg-base-200/60">
                    <summary class="collapse-title font-semibold">Show all manual videos</summary>
                    <div class="collapse-content">
                        {{ render_video_table(other_videos, focus_person) }}
                    </div>
                </details>
                {% endif %}
            {% else %}
                {% if videos %}
                    {{ render_video_table(videos, focus_person) }}
                {% else %}
                <div class="alert bg-base-100">
                    <span>All manual tagging work is complete. New videos without faces will appear here automatically.</span>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
